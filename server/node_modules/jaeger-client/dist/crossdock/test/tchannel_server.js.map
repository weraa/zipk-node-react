{"version":3,"sources":["../../../crossdock/test/tchannel_server.js"],"names":["constants","crossdock_constants","process","env","NODE_ENV","describe","ip","server","tracer","bridge","crossdockSpecPath","path","join","__dirname","before","Tracer","InMemoryReporter","ConstSampler","TChannelBridge","TChannelServer","Utils","myIp","it","span","startSpan","setBaggageItem","BAGGAGE_KEY","clientChannel","TChannel","requestChannel","makeSubChannel","serviceName","peers","thriftChannel","channel","entryPoint","tracedChannel","joinRequest","serverRole","downstream","host","port","transport","context","DefaultContext","setSpan","request","timeout","headers","cn","send","err","res","assert","isNotOk","traceResponse","body","equal","traceId","traceIdStr","sampled","baggage","getBaggageItem","done"],"mappings":"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","file":"tchannel_server.js","sourcesContent":["// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport _ from 'lodash';\nimport { assert } from 'chai';\nimport * as constants from '../../src/constants';\nimport * as crossdock_constants from '../src/constants';\nimport ConstSampler from '../../src/samplers/const_sampler.js';\nimport DefaultContext from '../../src/default_context';\nimport opentracing from 'opentracing';\nimport InMemoryReporter from '../../src/reporters/in_memory_reporter.js';\nimport TChannelBridge from '../../src/tchannel_bridge';\nimport TChannelServer from '../src/tchannel_server.js';\nimport TChannelAsThrift from 'tchannel/as/thrift';\nimport TChannel from 'tchannel';\nimport Tracer from '../../src/tracer.js';\nimport fs from 'fs';\nimport path from 'path';\nimport Utils from '../../src/util.js';\n\nprocess.env.NODE_ENV = 'test';\n\n// WARNING THESE TESTS DO NOT WORK WHEN THE VPN IS RUNNING.\n\ndescribe('crossdock tchannel server should', () => {\n  let ip;\n  let server;\n  let tracer;\n  let bridge;\n  let crossdockSpecPath = path.join(\n    __dirname,\n    '..',\n    '..',\n    'src',\n    'jaeger-idl',\n    'thrift',\n    'crossdock',\n    'tracetest.thrift'\n  );\n\n  before(() => {\n    tracer = new Tracer('node', new InMemoryReporter(), new ConstSampler(false));\n    bridge = new TChannelBridge(tracer);\n    server = new TChannelServer(crossdockSpecPath);\n    ip = Utils.myIp();\n  });\n\n  describe('joinTrace with different options', () => {\n    it('propagate span state on tchannel joinTrace', done => {\n      let span = tracer.startSpan('test-span');\n      span.setBaggageItem(crossdock_constants.BAGGAGE_KEY, 'fry');\n\n      let clientChannel = new TChannel();\n\n      let requestChannel = clientChannel.makeSubChannel({\n        serviceName: 'node',\n        peers: [Utils.myIp() + ':8082'],\n      });\n      let thriftChannel = TChannelAsThrift({\n        channel: requestChannel,\n        entryPoint: crossdockSpecPath,\n      });\n      let tracedChannel = bridge.tracedChannel(thriftChannel);\n\n      let joinRequest = {\n        serverRole: 'S1',\n        downstream: {\n          serviceName: 'node',\n          serverRole: 'S2',\n          host: Utils.myIp(),\n          port: '8082',\n          transport: 'TCHANNEL',\n        },\n      };\n\n      let context = new DefaultContext();\n      context.setSpan(span);\n      tracedChannel\n        .request({\n          timeout: 100000,\n          context: context,\n          serviceName: 'node',\n          headers: {\n            cn: 'node-tchannel',\n          },\n        })\n        .send('TracedService::joinTrace', null, { request: joinRequest }, (err, res) => {\n          if (err) {\n            assert.isNotOk(err);\n          } else {\n            let traceResponse = res.body;\n            assert.equal(traceResponse.span.traceId, span.context().traceIdStr);\n            assert.equal(traceResponse.span.traceId, traceResponse.downstream.span.traceId);\n            assert.equal(traceResponse.span.sampled, false);\n            assert.equal(traceResponse.span.baggage, span.getBaggageItem(crossdock_constants.BAGGAGE_KEY));\n          }\n          done();\n        });\n    }).timeout(100000);\n  });\n});\n"]}