{"version":3,"sources":["../../src/configuration.js"],"names":["constants","jaegerSchema","id","type","properties","serviceName","disable","sampler","param","host","port","refreshIntervalMs","required","additionalProperties","reporter","logSpans","agentHost","agentPort","flushIntervalMs","throttler","Configuration","config","options","Error","SAMPLER_TYPE_PROBABILISTIC","ProbabilisticSampler","SAMPLER_TYPE_RATE_LIMITING","RateLimitingSampler","SAMPLER_TYPE_CONST","ConstSampler","SAMPLER_TYPE_REMOTE","RemoteSampler","refreshInterval","metrics","logger","reporterConfig","reporters","senderConfig","push","LoggingReporter","sender","UDPSender","remoteReporter","RemoteReporter","length","CompositeReporter","throttlerOptions","Utils","clone","RemoteThrottler","Metrics","opentracing","Tracer","_getSampler","_getReporter","_getThrottler","info","name","tags","debugThrottler"],"mappings":"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","file":"configuration.js","sourcesContent":["// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport ConstSampler from './samplers/const_sampler';\nimport ProbabilisticSampler from './samplers/probabilistic_sampler';\nimport RateLimitingSampler from './samplers/ratelimiting_sampler';\nimport RemoteReporter from './reporters/remote_reporter';\nimport CompositeReporter from './reporters/composite_reporter';\nimport LoggingReporter from './reporters/logging_reporter';\nimport RemoteSampler from './samplers/remote_sampler';\nimport Metrics from './metrics/metrics';\nimport Tracer from './tracer';\nimport UDPSender from './reporters/udp_sender';\nimport opentracing from 'opentracing';\nimport * as constants from './constants.js';\nimport RemoteThrottler from './throttler/remote_throttler';\nimport Utils from './util.js';\n\nlet jaegerSchema = {\n  id: '/jaeger',\n  type: 'object',\n  properties: {\n    serviceName: { type: 'string' },\n    disable: { type: 'boolean' },\n    sampler: {\n      properties: {\n        type: { type: 'string' },\n        param: { type: 'number' },\n        host: { type: 'string' },\n        port: { type: 'number' },\n        refreshIntervalMs: { type: 'number' },\n      },\n      required: ['type', 'param'],\n      additionalProperties: false,\n    },\n    reporter: {\n      properties: {\n        logSpans: { type: 'boolean' },\n        agentHost: { type: 'string' },\n        agentPort: { type: 'number' },\n        flushIntervalMs: { type: 'number' },\n      },\n      additionalProperties: false,\n    },\n    throttler: {\n      properties: {\n        host: { type: 'string' },\n        port: { type: 'number' },\n        refreshIntervalMs: { type: 'number' },\n      },\n      additionalProperties: false,\n    },\n  },\n};\n\nexport default class Configuration {\n  static _getSampler(config, options) {\n    let type = config.sampler.type;\n    let param = config.sampler.param;\n    let host = config.sampler.host;\n    let port = config.sampler.port;\n    let refreshIntervalMs = config.sampler.refreshIntervalMs;\n\n    if (typeof param !== 'number') {\n      throw new Error(`Expecting sampler.param to be a number. Received ${param}`);\n    }\n\n    let sampler;\n    if (type === constants.SAMPLER_TYPE_PROBABILISTIC) {\n      sampler = new ProbabilisticSampler(param);\n    }\n\n    if (type === constants.SAMPLER_TYPE_RATE_LIMITING) {\n      sampler = new RateLimitingSampler(param);\n    }\n\n    if (type === constants.SAMPLER_TYPE_CONST) {\n      sampler = new ConstSampler(param === 1);\n    }\n\n    if (type === constants.SAMPLER_TYPE_REMOTE) {\n      sampler = new RemoteSampler(config.serviceName, {\n        sampler: new ProbabilisticSampler(param),\n        host: host,\n        port: port,\n        refreshInterval: refreshIntervalMs,\n        metrics: options.metrics,\n        logger: options.logger,\n      });\n    }\n\n    return sampler;\n  }\n\n  static _getReporter(config, options) {\n    let reporterConfig = {};\n    let reporters = [];\n    let senderConfig = {\n      logger: options.logger,\n    };\n    if (config.reporter) {\n      if (config.reporter.logSpans) {\n        reporters.push(new LoggingReporter(options.logger));\n      }\n\n      if (config.reporter.flushIntervalMs) {\n        reporterConfig['bufferFlushInterval'] = config.reporter.flushIntervalMs;\n      }\n\n      if (config.reporter.agentHost) {\n        senderConfig['host'] = config.reporter.agentHost;\n      }\n\n      if (config.reporter.agentPort) {\n        senderConfig['port'] = config.reporter.agentPort;\n      }\n    }\n    reporterConfig['metrics'] = options.metrics;\n    reporterConfig['logger'] = options.logger;\n    let sender = new UDPSender(senderConfig);\n    let remoteReporter = new RemoteReporter(sender, reporterConfig);\n    if (reporters.length == 0) {\n      return remoteReporter;\n    }\n    reporters.push(remoteReporter);\n    return new CompositeReporter(reporters);\n  }\n\n  static _getThrottler(config, options) {\n    const throttlerOptions = Utils.clone(config.throttler);\n    if (options.logger) {\n      throttlerOptions.logger = options.logger;\n    }\n    if (options.metrics) {\n      throttlerOptions.metrics = options.metrics;\n    }\n    return new RemoteThrottler(config.serviceName, throttlerOptions);\n  }\n\n  /**\n   * Initialize and return a new instance of Jaeger Tracer.\n   *\n   * The config dictionary is not validated for adherence to the schema above.\n   * Such validation can be performed like this:\n   *\n   *     import {Validator} from 'jsonschema';\n   *\n   *     let v = new Validator();\n   *     v.validate(config, jaegerSchema, {\n   *       throwError: true\n   *     });\n   *\n   * @param {Object} config - configuration matching the jaegerSchema definition.\n   * @param {Object} options - options\n   * @param {Object} [options.reporter] - if provided, this reporter will be used.\n   *        Otherwise a new reporter will be created according to the description\n   *        in the config.\n   * @param {Object} [options.throttler] - if provided, this throttler will be used.\n   *        Otherwise a new throttler will be created according to the description\n   *        in the config.\n   * @param {Object} [options.metrics] - a metrics factory (see ./_flow/metrics.js)\n   * @param {Object} [options.logger] - a logger (see ./_flow/logger.js)\n   * @param {Object} [options.tags] - set of key-value pairs which will be set\n   *        as process-level tags on the Tracer itself.\n   */\n  static initTracer(config, options = {}) {\n    let reporter;\n    let sampler;\n    let throttler;\n    if (options.metrics) {\n      options.metrics = new Metrics(options.metrics);\n    }\n    if (config.disable) {\n      return new opentracing.Tracer();\n    }\n    if (!config.serviceName) {\n      throw new Error(`config.serviceName must be provided`);\n    }\n    if (config.sampler) {\n      sampler = Configuration._getSampler(config, options);\n    } else {\n      sampler = new RemoteSampler(config.serviceName, options);\n    }\n    if (!options.reporter) {\n      reporter = Configuration._getReporter(config, options);\n    } else {\n      reporter = options.reporter;\n    }\n    if (!options.throttler) {\n      if (config.throttler) {\n        throttler = Configuration._getThrottler(config, options);\n      }\n    } else {\n      throttler = options.throttler;\n    }\n\n    if (options.logger) {\n      options.logger.info(`Initializing Jaeger Tracer with ${reporter.name()} and ${sampler.name()}`);\n    }\n\n    return new Tracer(config.serviceName, reporter, sampler, {\n      metrics: options.metrics,\n      logger: options.logger,\n      tags: options.tags,\n      debugThrottler: throttler,\n    });\n  }\n}\n"]}